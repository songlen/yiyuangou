<include file="public/header" title="提交订单" body="g4"/>
<include file="public/header_nav" title="提交订单" href="{:U('mobile/Cart/index')}"/>
<script src="__PUBLIC__/js/md5.min.js"></script>
<style>
    div.cuptyp {
        box-sizing: content-box;
        border: 2px solid transparent;
    }

    div.checked {
        border: 2px solid #e23435;
    }

    .phoneclck {
        /*部分手机不能点击问题*/
        cursor: pointer
    }
    .jisong { font-size: 0.7rem; margin-left: 0.85rem; padding-top: 0.6rem; }
</style>
<form name="cart2_form" id="cart2_form" method="post">
    <!--立即购买才会用到-s-->
    <input type="hidden" name="act_id" value="{$Request.param.act_id}">
    <input type="hidden" name="action" value="{$Request.param.action}">
    <input type="hidden" name="goods_id" value="{$Request.param.goods_id}">
    <input type="hidden" name="auth_code" value="{$Think.config.AUTH_CODE}"/>
    <!--立即购买才会用到-e-->
    <div class="edit_gtfix">
        <a href="{:U('Mobile/User/address_list',array('source'=>'cart2','goods_id'=>$Request.param.goods_id,'goods_num'=>$Request.param.goods_num,'item_id'=>$Request.param.item_id,'action'=>$Request.param.action))}">
            <if condition="!empty($address)">
            <div class="namephone fl">
                <div class="jisong">寄送地址</div>
                <div class="top">
                    <div class="le fl">{$address.consignee}</div>
                    <div class="lr fl">{$address.mobile}</div>
                </div>
                <div class="bot">
                    <i class="dwgp"></i>
                    <span>{$address.address}</span>
                </div>
                <input type="hidden" name="address_id" value="{$address.address_id}"/> <!--收货地址id-->
            </div>
            <div class="fr youjter">
                <i class="Mright"></i>
            </div>

        <else/>
            <div class="namephone fl">
                <div class="top">
                    <div class="le fl"></div>
                    <div class="lr fl">请先先写收货信息</div>
                </div>
                <div class="bot">
                    <i class="dwgp"></i>
                    <span></span>
                </div>
            </div>
            <div class="fr youjter">
                <i class="Mright"></i>
            </div>
            <div class="ttrebu">
                <img src="__STATIC__/images/tt.png"/>
            </div>
        </if>
        </a>
    </div>

    <!--商品信息-s-->
    <div class="ord_list fill-orderlist p">
        <div class="maleri30">
            <volist name="cartList" id="cart">
                <input type="hidden" name="act_id[]" value="{$cart[act_id]}">
                <input type="hidden" name="num[]" value="{$cart[num]}">
                <div class="shopprice inputOrder">
                    <div class="img_or fl"><img src="{$cart[goods_id]|goods_thum_images=100,100}"/></div>
                    <div class="fon_or fl">
                        <h2 class="similar-product-text">{$cart[goods_name]}</h2>
                    </div> 
                    <div class="changeNum">
                        <div class="shutext">数量：{$cart.num}</div>

                        <!-- <div class="jian"><img onclick="jian()" src="__STATIC__/default/images/jian.png" /></div> -->
                        <!-- <div class="num"><input type="text" name="num" value="{$cart.goods_num}" onblur="input({$cart.prom_id})" /></div> -->
                        <!-- <div class="jia"><img onclick="jia({$cart.prom_id})" src="__STATIC__/default/images/jia.png" /></div> -->
                    </div>
                </div>
            </volist>
        </div>
    </div>
    <!--商品信息-e-->
    <div class="jifeninfo">
        <div class="con">积分 共{$user['pay_points']}积分 <i class="jifentip"></i></div>
    </div>

    <div class="orderBeforInfo">
        <ul>
            <li><label>商品金额</label><span class="shop_price">${$priceInfo.money}</span></li>
            <li><label>税率</label><span class="tax_rate">{$priceInfo.tax_rate}</span></li>
            <li><label>税后金额</label><span class="tax_amount">{$priceInfo.tax_amount}</span></li>
            <li class="jifenxiaofei" style="display: none;"><label>消费积分</label><span class="use_point">0</span></li>
        </ul>
        <div class="split"></div>
        <div class="select_jifen_tab">
            <input type="hidden" name="use_jifen" value="0">
            <span><i class="no_select use_jifen"></i>积分购买</span>
            <span><i class="no_select selected"></i>直接购买</span>
        </div>
        <div class="orderTotal"> 
            <div class="total_amount">${$priceInfo.total_amount}</div>
            <div class="t">实付款</div>
        </div>
    </div>
    <button type="button" class="submit">提交订单</button>
</form>

<script type="text/javascript">

   

    // 提交订单
    ajax_return_status = 1; // 标识ajax 请求是否已经回来 可以进行下一次请求
    function submit_order() {
        if ($('.submit_price a').hasClass("disable")) {
            return;
        }
        if (ajax_return_status == 0)
            return false;
        ajax_return_status = 0;
        layer.open({type: 2,content: '订单提交中'});
        $.ajax({
            type: "POST",
            url: "{:U('Mobile/Cart/cart3')}",//+tab,
            data: $('#cart2_form').serialize() + "&act=submit_order",// 你的formid
            dataType: "json",
            success: function (data) {
            	layer.closeAll();
                if (data.status != '1') {
                    showErrorMsg(data.msg);  //执行有误
                    // 登录超时
                    if (data.status == -100)
                        location.href = "{:U('Mobile/User/login')}";
                    	ajax_return_status = 1; // 上一次ajax 已经返回, 可以进行下一次 ajax请求
                    return false;
                }
                $("#postFee").text(data.result.shipping_price); // 物流费
                if (data.result.coupon_price == null) {
                    $("#couponFee").text(0);// 优惠券
                } else {
                    $("#couponFee").text(data.result.coupon_price);// 优惠券
                }
                $("#balance").text(data.result.user_money);// 余额
                $("#pointsFee").text(data.result.integral_money);// 积分支付
                $("#payables").text(data.result.order_amount);// 应付
                $("#order_prom_amount").text(data.result.order_prom_amount);// 订单 优惠活动
                showErrorMsg('订单提交成功，跳转支付页面!');
                location.href = "/index.php?m=Mobile&c=Cart&a=cart4&order_sn=" + data.result;
            }
        });
    }



    // 加数量
    function jia(act_id){
        var now_val = parseInt($('.changeNum .num input').val());
        var num = now_val+1;

         // 公共方法计算金额
        if(ajaxTotalAmount() == false) return false;

        $('.changeNum .num input').val(num);
    }   
    // 减数量
    function jian(){
        var now_val = parseInt($('.changeNum .num input').val());
        if(now_val <= 1) return false;
        var val = now_val-1;
        // 公共方法计算金额
        if(ajaxTotalAmount() == false) return false;

        $('.changeNum .num input').val(val);
    }

    function input(act_id){
        var num = parseInt($('.changeNum .num input').val());
        if(num <= 1 || isNaN(num)) num = 1;
         // 公共方法计算金额
        if(ajaxTotalAmount() == false){
           $('.changeNum .num input').val(1);
        }
    }

    // function ajaxCheckActNum(act_id, num){
    //     var re = true;
    //     $.ajax({
    //         url:'{:U("mobile/cart/ajaxCheckActNum")}',
    //         type:'post',
    //         dataType:'json',
    //         async:false,
    //         data:{act_id:act_id, num:num},
    //         success:function(data){
    //             if(data.status=='-1'){
    //                 showErrorMsg(data.msg);
    //                 re = false;
    //             }
    //         }
    //     })

    //     return re;
    // }

    // 积分购买还是直接购买
    $(function(){
        $('.no_select').click(function(){
            if($(this).hasClass('use_jifen')){

                // 计算金额
                if(ajaxTotalAmount() ==  false) return;

                $('.no_select').removeClass('selected');
                $(this).addClass('selected');
                $('.jifenxiaofei').show();
            } else {
                $('.no_select').removeClass('selected');
                $(this).addClass('selected');
                $('.jifenxiaofei').hide();
            }
        })
    })

     // 获取订单价格
    function ajaxTotalAmount() {
        re = true;

        $.ajax({
            type: "POST",
            url: '/index.php?m=Mobile&c=Cart&a=ajaxTotalAmount',
            data: $('#cart2_form').serialize(),
            dataType: "json",
            async:false,
            success: function (data) {
                if(data.status == '-1'){
                    showErrorMsg(data.msg);
                    re = false;
                }

                if(data.status == 200){
                    refresh_price(data.data);
                }
               
            }
           
        });
         return re;
    }

    function refresh_price(data) {
        console.log(data);
        $('.shop_price').text('$'+data.shop_price);//商品金额
        $('.tax_rate').text(data.tax_rate);//税率
        $(".tax_amount").text('$'+data.tax_amount);// 税后金额
        $(".use_point").text('$'+data.use_point);// 消费积分
       
        $(".total_amount").text(data.total_amount);// 应付
    }

</script>
</body>
</html>
